// Generated by CoffeeScript 1.3.1
(function() {
  var find_templates, format_date, getCookie, months, number_postfix, summarize, templates, time_range,
    __slice = [].slice;

  window.getCookie = getCookie = function(name, source) {
    var c, cookies, raw_name, value, _i, _len, _ref;
    if (source == null) {
      source = document.cookie;
    }
    if (source && source !== '') {
      cookies = source.split(';');
      for (_i = 0, _len = cookies.length; _i < _len; _i++) {
        c = cookies[_i];
        _ref = $.trim(c).split('=', 2), raw_name = _ref[0], value = _ref[1];
        if (raw_name === name) {
          return decodeURIComponent(value);
        }
      }
    }
    return null;
  };

  $(document).ajaxSend(function(evt, xhr, settings) {
    var safeMethod, sameOrigin;
    sameOrigin = function(url) {
      var host, origin, protocol, sr_origin;
      host = document.location.host;
      protocol = document.location.protocol;
      sr_origin = '//' + host;
      origin = protocol + sr_origin;
      return (url === origin || url.slice(0, origin.length + 1) === origin + '/') || (url === sr_origin || url.slice(0, sr_origin.length + 1) === sr_origin + '/') || !(/^(\/\/|http:|https:).*/.test(url));
    };
    safeMethod = function(method) {
      return /^(GET|HEAD|OPTIONS|TRACE)$/.test(method);
    };
    if (!safeMethod(settings.type) && sameOrigin(settings.url)) {
      return xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
    }
  });

  (function() {
    var cache, tmpl;
    cache = {};
    return tmpl = this.tmpl = function(str, data) {
      var fn;
      fn = new Function("obj", "var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('" + str.replace(/[\r\t\n]/g, " ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g, "$1\r").replace(/\t=(.*?)%>/g, "',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'") + "');}return p.join('');");
      if (data) {
        return fn(data);
      } else {
        return fn;
      }
    };
  })();

  find_templates = function(elements) {
    var results;
    results = {};
    $(elements).each(function() {
      var el;
      el = $(this);
      return results[el.attr('id')] = tmpl(el.html());
    });
    return results;
  };

  templates = {};

  $(function() {
    return window.templates = templates = find_templates('script[type="text/template"]');
  });

  summarize = function(elements, max_length) {
    return $(elements).each(function() {
      var el;
      el = $(this);
      if (el.text().length > max_length + 53) {
        if (el.data('full-text') != null) {
          return;
        }
        el.data('full-text', el.text());
        el.text(el.text().substring(0, max_length) + '... ');
        el.append('<a href="#read-more" class="read-more">more</a>');
        return el.find('.read-more').click(function() {
          el.text(el.data('full-text'));
          return $(window).trigger('summary-expanded', [el, el.text()]);
        });
      }
    });
  };

  $(function() {
    return summarize('.summarize', 250);
  });

  $(function() {
    var elements, resized;
    elements = null;
    resized = function() {
      var children, cutoff, width;
      width = $(window).width();
      cutoff = 992;
      if (elements != null) {
        elements.masonry('destroy');
        elements = null;
      }
      if (width >= cutoff) {
        elements = $('.events');
        children = elements.find('.event');
        return elements.masonry({
          itemSelector: '.event',
          columnWidth: children.width() + parseInt(children.css('padding-left'), 10) + parseInt(children.css('padding-right'), 10)
        });
      }
    };
    $(window).bind('resize', resized);
    $(window).bind('summary-expanded', resized);
    return resized();
  });

  window.format = function() {
    var obj, string, values;
    string = arguments[0], values = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    if (values.length < 1) {
      return string;
    }
    if (values.length === 1 && $.type(values[0]) === 'object') {
      obj = values[0];
      return string.replace(/{{ *([a-zA-Z0-9_-]+) *}}/g, function(match, identifer) {
        if (obj[identifer] != null) {
          return obj[identifer];
        } else {
          return match;
        }
      });
    } else {
      return string.replace(/{{ *(\d+) *}}/g, function(match, index) {
        if (values[index] != null) {
          return values[index];
        } else {
          return match;
        }
      });
    }
  };

  number_postfix = function(n) {
    if (n === 1) {
      return 'st';
    } else if (n === 2) {
      return 'nd';
    } else if (n === 3) {
      return 'rd';
    } else {
      return 'th';
    }
  };

  months = ['January', 'Feburary', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'November', 'October', 'December'];

  format_date = function(str, date) {
    return format(str, {
      year: date.getYear(),
      month: months[date.getMonth()],
      day: date.getDay(),
      day_th: number_postfix(date.getDay()),
      hour: date.getHours() % 12 + 1,
      min: date.getMinutes(),
      apm: date.getHours() < 12 ? 'am' : 'pm'
    });
  };

  time_range = function(start, end) {
    var diff, result, str;
    diff = {
      year: start.getYear() !== end.getYear(),
      month: start.getMonth() !== end.getMonth(),
      day: start.getDay() !== end.getDay(),
      hour: start.getHours() !== end.getHours(),
      minute: start.getMinutes() !== end.getMinutes(),
      apm: (start.getHours() < 12) !== (end.getHours() < 12)
    };
    str = [];
    if (diff.month) {
      str.push('{{ month }}');
    }
    if (diff.day) {
      if (diff.year) {
        str.push('{{ day }}{{ day_th }},');
      } else {
        str.push('{{ day }}{{ day_th }}');
      }
    }
    if (diff.year) {
      str.push('{{ year }}');
    }
    if (diff.hour || diff.minute) {
      if (diff.minute) {
        str.push('{{ hour }}:{{ minute }}');
      } else {
        str.push('{{ hour }}');
      }
    }
    if (diff.apm) {
      str.push('{{ apm }}');
    }
    str = str.join(' ');
    result = format_date(str, start) + ' - ' + format_date(str, end);
    if (!diff.apm) {
      return result + format_date(' {{ apm }}', end);
    } else {
      return result;
    }
  };

  $(function() {
    var target;
    target = $('.events');
    console.log('ajax request...');
    return $.ajax({
      url: '/api/events/',
      type: 'get',
      dataType: 'json',
      success: function(data) {
        var end_time, row, start_time, _i, _len, _ref;
        target.empty();
        _ref = data.results;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          row = _ref[_i];
          start_time = new Date(row.start_time * 1000);
          end_time = new Date(row.end_time * 1000);
          target.append(templates.event_template({
            image_url: row.pic_square,
            title: row.name,
            time: time_range(start_time, end_time),
            location: row.location,
            description: row.description
          }));
        }
        return summarize('.summarize', 250);
      }
    });
  });

}).call(this);
